<!DOCTYPE html>
<html>
<head>
    <title>Atlantic & Americas Treasure Map v4.2</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info-panel {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255,255,255,0.95); padding: 12px;
            border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.3);
            max-width: 280px; z-index: 1000; max-height: 92vh;
            overflow-y: auto; font-size: 11px;
        }
        .info-panel h3 { margin: 0 0 8px 0; font-size: 14px; }
        .counts { font-family: monospace; font-size: 10px; background: #f0f0f0; padding: 4px 6px; border-radius: 3px; margin-bottom: 8px; }
        h4 { margin: 10px 0 5px 0; font-size: 11px; border-bottom: 1px solid #ccc; padding-bottom: 3px; }
        .layer-toggle { margin: 3px 0; }
        .layer-toggle label { cursor: pointer; display: flex; align-items: center; }
        .layer-toggle input { margin-right: 6px; }
        .legend-item { display: flex; align-items: center; margin: 3px 0; font-size: 10px; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 6px; border: 2px solid #333; }
        .legend-line { width: 20px; height: 3px; margin-right: 6px; }
        .legend-line.dashed { border-top: 2px dashed; height: 0; }
        .legend-box { width: 14px; height: 14px; margin-right: 6px; border: 2px dashed; }
        a { color: #0066cc; font-size: 10px; }
        
        .flyout {
            position: absolute; top: 0; left: -400px; z-index: 1001;
            width: 380px; height: 100vh; background: #fff;
            box-shadow: 2px 0 15px rgba(0,0,0,0.3);
            transition: left 0.3s ease; overflow-y: auto;
        }
        .flyout.open { left: 0; }
        .flyout-header {
            background: linear-gradient(135deg, #1a5276 0%, #2980b9 100%);
            color: white; padding: 15px; position: sticky; top: 0;
        }
        .flyout-header h2 { margin: 0; font-size: 18px; }
        .flyout-header .sub { font-size: 12px; opacity: 0.9; margin-top: 4px; }
        .flyout-close {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 16px;
        }
        .flyout-content { padding: 15px; font-size: 13px; line-height: 1.5; }
        .flyout-section { margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        .flyout-section h3 { margin: 0 0 8px 0; font-size: 12px; color: #666; text-transform: uppercase; }
        .info-box { background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 8px 0; }
        .info-box.gold { border-left: 4px solid #f1c40f; background: #fffde7; }
        .info-box.depth { border-left: 4px solid #3498db; background: #e3f2fd; }
        .info-box.battle { border-left: 4px solid #e74c3c; background: #ffebee; }
        .tag { display: inline-block; padding: 2px 6px; margin: 2px; background: #e0e0e0; border-radius: 10px; font-size: 10px; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="info-panel">
        <h3>üè¥‚Äç‚ò†Ô∏è Treasure Map v4.2</h3>
        <div class="counts" id="counts">Loading...</div>
        
        <h4>Toggle Layers</h4>
        <div class="layer-toggle"><label><input type="checkbox" id="toggleWrecks" checked> ‚öì Shipwrecks</label></div>
        <div class="layer-toggle"><label><input type="checkbox" id="toggleSeaRoutes" checked> üö¢ Sea Trade Routes</label></div>
        <div class="layer-toggle"><label><input type="checkbox" id="toggleLandRoutes"> üõ§Ô∏è Land Routes</label></div>
        <div class="layer-toggle"><label><input type="checkbox" id="toggleMines"> ‚õèÔ∏è Mining Sites</label></div>
        <div class="layer-toggle"><label><input type="checkbox" id="toggleMints"> ü™ô Colonial Mints</label></div>
        <div class="layer-toggle"><label><input type="checkbox" id="togglePirates" checked> üíÄ Pirate Havens</label></div>
        <div class="layer-toggle"><label><input type="checkbox" id="toggleMystery"> ‚ùì Mystery Finds</label></div>
        <div class="layer-toggle"><label><input type="checkbox" id="toggleLeases" checked> üìú Salvage Leases</label></div>
        <div class="layer-toggle"><label><input type="checkbox" id="toggleIncidents" checked> ‚öîÔ∏è Voyage Incidents</label></div>
        <div class="layer-toggle"><label><input type="checkbox" id="toggleRaids" checked> üè¥‚Äç‚ò†Ô∏è Pirate Raids</label></div>
        <div class="layer-toggle"><label><input type="checkbox" id="toggleOilWells"> üõ¢Ô∏è Gulf Oil Platforms</label></div>
        <div class="layer-toggle"><label><input type="checkbox" id="toggleFishing"> üé£ Fishing Spots</label></div>
        <div class="layer-toggle"><label><input type="checkbox" id="toggleReefs"> ü™∏ Artificial Reefs</label></div>
        
        <h4>Quick Toggle</h4>
        <button onclick="toggleAll(true)" style="font-size:10px;padding:3px 8px;margin:2px">All On</button>
        <button onclick="toggleAll(false)" style="font-size:10px;padding:3px 8px;margin:2px">All Off</button>
        
        <h4>Wrecks Legend</h4>
        <div class="legend-item"><div class="legend-color" style="background:#FFD700"></div> Treasure Ships</div>
        <div class="legend-item"><div class="legend-color" style="background:#2c3e50"></div> Pirate Ships</div>
        <div class="legend-item"><div class="legend-color" style="background:#e74c3c"></div> Fleet Disasters</div>
        <div class="legend-item"><div class="legend-color" style="background:#3498db"></div> Military/Naval</div>
        <div class="legend-item"><div class="legend-color" style="background:#27ae60"></div> Civilian/Other</div>
        
        <h4>Other Markers</h4>
        <div class="legend-item"><div class="legend-color" style="background:#8B4513"></div> Mining Sites</div>
        <div class="legend-item"><div class="legend-color" style="background:#C0C0C0"></div> Colonial Mints</div>
        <div class="legend-item"><div class="legend-color" style="background:#000;border-color:#c0392b"></div> Pirate Havens</div>
        <div class="legend-item"><div class="legend-color" style="background:#FFEB3B"></div> Mystery Finds</div>
        <div class="legend-item"><div class="legend-color" style="background:#e74c3c"></div> ‚öîÔ∏è Battles/Raids</div>
        <div class="legend-item"><div class="legend-color" style="background:#9b59b6"></div> üåÄ Storm Losses</div>
        <div class="legend-item"><div class="legend-color" style="background:#8B0000;border-color:#FFD700"></div> üè¥‚Äç‚ò†Ô∏è Pirate Raids</div>
        
        <h4>Routes</h4>
        <div class="legend-item"><div class="legend-line" style="background:#e74c3c"></div> Spanish Fleet</div>
        <div class="legend-item"><div class="legend-line" style="background:#3498db"></div> Portuguese Route</div>
        <div class="legend-item"><div class="legend-line dashed" style="border-color:#8B4513"></div> Land/Mule Routes</div>
        
        <h4>Fishing & Reefs</h4>
        <div class="legend-item"><div class="legend-color" style="background:#00BFFF;width:8px;height:8px"></div> Fishing Spots</div>
        <div class="legend-item"><div class="legend-color" style="background:#7B68EE;width:8px;height:8px;border-radius:2px"></div> Artificial Reefs</div>
        
        <h4>Oil Platforms</h4>
        <div class="legend-item"><div class="legend-color" style="background:#27ae60;width:8px;height:8px"></div> Active</div>
        <div class="legend-item"><div class="legend-color" style="background:#7f8c8d;width:8px;height:8px"></div> Inactive</div>
        <div class="legend-item"><div class="legend-color" style="background:#2c3e50;width:8px;height:8px"></div> Abandoned</div>
        <div class="legend-item"><div class="legend-color" style="background:#c0392b;width:8px;height:8px"></div> Destroyed</div>
        
        <h4>Salvage Leases</h4>
        <div class="legend-item"><div class="legend-box" style="background:rgba(255,215,0,0.2);border-color:#FFD700"></div> 1715 Fleet</div>
        <div class="legend-item"><div class="legend-box" style="background:rgba(0,206,209,0.2);border-color:#00CED1"></div> 1733 Fleet</div>
        <div class="legend-item"><div class="legend-box" style="background:rgba(255,0,255,0.2);border-color:#FF00FF"></div> Atocha</div>
        
        <h4>Data</h4>
        <a href="shipwreck_database.json" target="_blank">üìä Full Database JSON</a>
    </div>
    
    <div class="flyout" id="flyout">
        <div class="flyout-header">
            <button class="flyout-close" onclick="closeFlyout()">‚úï</button>
            <h2 id="flyout-title">Name</h2>
            <div class="sub" id="flyout-sub"></div>
        </div>
        <div class="flyout-content" id="flyout-content"></div>
    </div>

    <script>
        var map = L.map('map').setView([20, -60], 4);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap', maxZoom: 19
        }).addTo(map);
        
        var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '¬© Esri', maxZoom: 19
        });
        L.control.layers({"Street": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'), "Satellite": satellite}).addTo(map);
        
        // Layer groups
        var wrecksLayer = L.layerGroup().addTo(map);
        var seaRoutesLayer = L.layerGroup().addTo(map);
        var landRoutesLayer = L.layerGroup();
        var minesLayer = L.layerGroup();
        var mintsLayer = L.layerGroup();
        var piratesLayer = L.layerGroup().addTo(map);
        var mysteryLayer = L.layerGroup();
        var leasesLayer = L.layerGroup().addTo(map);
        var incidentsLayer = L.layerGroup().addTo(map);
        var raidsLayer = L.layerGroup().addTo(map);
        var oilWellsLayer = L.layerGroup(); // Off by default
        var fishingLayer = L.layerGroup(); // Off by default
        var reefsLayer = L.layerGroup(); // Off by default

        // Salvage Lease Areas
        var salvageLeases = [
            {name: "1715 Fleet Lease", coords: [[27.86,-80.45],[27.86,-80.20],[27.25,-80.20],[27.25,-80.35],[27.60,-80.40]], color: "#FFD700", notes: "Queens Jewels LLC - Active salvage"},
            {name: "1733 Fleet Lease", coords: [[25.08,-80.45],[25.08,-80.25],[24.70,-80.55],[24.70,-80.85]], color: "#00CED1", notes: "Florida Keys"},
            {name: "Atocha/Margarita Lease", coords: [[24.65,-81.40],[24.65,-81.90],[24.40,-82.10],[24.40,-81.40]], color: "#FF00FF", notes: "Mel Fisher's Treasures"},
            {name: "Maravillas Lease", coords: [[27.25,-78.80],[27.25,-79.20],[26.90,-79.20],[26.90,-78.80]], color: "#FFA500", notes: "Little Bahama Bank"},
            {name: "San Jos√© Zone", coords: [[10.45,-76.00],[10.45,-76.15],[10.32,-76.15],[10.32,-76.00]], color: "#FF6347", notes: "Colombian protected"}
        ];

        var dbData = null;

        function getWreckColor(wreck) {
            var name = (wreck.name || '').toLowerCase();
            var type = (wreck.type || '').toLowerCase();
            if (type.includes('pirate')) return '#2c3e50';
            if (type.includes('fleet') || name.includes('1715') || name.includes('1733')) return '#e74c3c';
            if (type.includes('military') || type.includes('naval') || name.includes('uss ')) return '#3498db';
            if (type.includes('treasure') || type.includes('galleon') || wreck.treasure_type) return '#FFD700';
            return '#27ae60';
        }

        function createMarker(lat, lng, color, size, borderStyle) {
            var border = borderStyle || '2px solid #333';
            return L.divIcon({
                className: 'marker',
                html: '<div style="background:'+color+';width:'+size+'px;height:'+size+'px;border-radius:50%;border:'+border+';box-shadow:0 1px 3px rgba(0,0,0,0.4)"></div>',
                iconSize: [size, size], iconAnchor: [size/2, size/2]
            });
        }

        function openFlyout(title, sub, content) {
            document.getElementById('flyout-title').textContent = title;
            document.getElementById('flyout-sub').textContent = sub;
            document.getElementById('flyout-content').innerHTML = content;
            document.getElementById('flyout').classList.add('open');
        }
        function closeFlyout() {
            document.getElementById('flyout').classList.remove('open');
        }

        function loadData() {
            fetch('shipwreck_database.json?v=' + Date.now())
                .then(r => r.json())
                .then(data => {
                    dbData = data;
                    renderAll(data);
                })
                .catch(e => {
                    console.error('Failed to load database:', e);
                    document.getElementById('counts').textContent = 'Error loading data';
                });
        }

        function renderAll(data) {
            // Clear layers
            wrecksLayer.clearLayers();
            seaRoutesLayer.clearLayers();
            landRoutesLayer.clearLayers();
            minesLayer.clearLayers();
            mintsLayer.clearLayers();
            piratesLayer.clearLayers();
            mysteryLayer.clearLayers();
            leasesLayer.clearLayers();
            incidentsLayer.clearLayers();
            raidsLayer.clearLayers();
            oilWellsLayer.clearLayers();
            fishingLayer.clearLayers();
            reefsLayer.clearLayers();

            var wrecks = data.wrecks || [];
            var routes = (data.trade_routes && data.trade_routes.routes) || [];
            var mines = (data.mining_sites && data.mining_sites.sites) || [];
            var mints = (data.mints && data.mints.mints) || [];
            var landRoutes = (data.land_routes && data.land_routes.routes) || [];
            var pirates = (data.pirate_havens && data.pirate_havens.havens) || [];
            var mystery = (data.mystery_finds && data.mystery_finds.finds) || [];
            var incidents = (data.voyage_incidents && data.voyage_incidents.incidents) || [];

            document.getElementById('counts').textContent = 
                '‚öì'+wrecks.length+' üíÄ'+pirates.length+' ‚öîÔ∏è'+incidents.length+' ‚õèÔ∏è'+mines.length;

            // Wrecks
            wrecks.forEach(function(w) {
                if (!w.location) return;
                var lat = w.location.lat, lng = w.location.lng || w.location.lon;
                var color = getWreckColor(w);
                var size = w.treasure_type ? 14 : 10;
                var border = (w.recovered === false && w.location.location_uncertainty_km > 0) ? '2px dashed #c0392b' : '2px solid #333';
                var icon = createMarker(lat, lng, color, size, border);
                var marker = L.marker([lat, lng], {icon: icon}).addTo(wrecksLayer);
                marker.on('click', function() {
                    var content = '<div class="flyout-section"><h3>Location</h3>';
                    content += '<p>'+(w.location.description||'')+'</p>';
                    content += '<p><strong>'+lat.toFixed(4)+'¬∞, '+lng.toFixed(4)+'¬∞</strong></p>';
                    if (w.location.depth_ft) content += '<div class="info-box depth">Depth: '+w.location.depth_ft+' ft</div>';
                    content += '</div>';
                    if (w.cargo) content += '<div class="flyout-section"><h3>Cargo</h3><p>'+w.cargo+'</p></div>';
                    if (w.treasure_type) {
                        content += '<div class="flyout-section"><h3>Treasure</h3><div>';
                        w.treasure_type.forEach(function(t) { content += '<span class="tag">'+t+'</span>'; });
                        content += '</div></div>';
                    }
                    if (w.notes) content += '<div class="flyout-section"><h3>Notes</h3><p>'+w.notes+'</p></div>';
                    if (w.casualties) content += '<div class="flyout-section"><h3>Casualties</h3><p>'+w.casualties+'</p></div>';
                    if (w.links && w.links.length) {
                        content += '<div class="flyout-section"><h3>Links</h3>';
                        w.links.forEach(function(l) { content += '<a href="'+l+'" target="_blank">'+l+'</a><br>'; });
                        content += '</div>';
                    }
                    openFlyout('‚öì '+w.name, (w.year||'')+(w.type?' ‚Ä¢ '+w.type:''), content);
                });
            });

            // Sea Routes - handle dateline crossing
            routes.forEach(function(r) {
                if (!r.waypoints || r.waypoints.length < 2) return;
                var color = '#e74c3c';
                if ((r.name||'').toLowerCase().includes('portuguese')) color = '#3498db';
                if ((r.name||'').toLowerCase().includes('manila') || (r.name||'').toLowerCase().includes('dutch') || (r.name||'').toLowerCase().includes('voc')) color = '#f39c12';
                
                // Split route at dateline crossings (longitude jumps > 180)
                var segments = [];
                var currentSegment = [];
                for (var i = 0; i < r.waypoints.length; i++) {
                    var wp = r.waypoints[i];
                    currentSegment.push([wp.lat, wp.lng]);
                    if (i < r.waypoints.length - 1) {
                        var nextWp = r.waypoints[i + 1];
                        var lngDiff = Math.abs(wp.lng - nextWp.lng);
                        if (lngDiff > 180) {
                            // Dateline crossing - end this segment, start new one
                            segments.push(currentSegment);
                            currentSegment = [];
                        }
                    }
                }
                if (currentSegment.length > 0) segments.push(currentSegment);
                
                // Draw each segment
                segments.forEach(function(seg) {
                    if (seg.length >= 2) {
                        L.polyline(seg, {color: color, weight: 3, opacity: 0.7}).addTo(seaRoutesLayer)
                            .bindPopup('<b>'+r.name+'</b><br>'+(r.period||''));
                    }
                });
            });

            // Land Routes
            landRoutes.forEach(function(r) {
                if (!r.waypoints || r.waypoints.length < 2) return;
                var coords = r.waypoints.map(function(wp) { return [wp.lat, wp.lng]; });
                L.polyline(coords, {color: '#8B4513', weight: 3, opacity: 0.7, dashArray: '8,6'}).addTo(landRoutesLayer)
                    .bindPopup('<b>'+r.name+'</b><br>'+(r.distance_km ? r.distance_km+' km' : ''));
            });

            // Mining Sites
            mines.forEach(function(m) {
                var icon = createMarker(m.lat, m.lng, '#8B4513', 12);
                L.marker([m.lat, m.lng], {icon: icon}).addTo(minesLayer)
                    .on('click', function() {
                        var content = '<div class="flyout-section"><h3>Details</h3>';
                        content += '<p><strong>Mineral:</strong> '+(m.mineral||m.mineral_type||'Silver')+'</p>';
                        if (m.peak_years) content += '<p><strong>Peak:</strong> '+m.peak_years+'</p>';
                        if (m.notes || m.description) content += '<p>'+(m.notes||m.description)+'</p>';
                        content += '</div>';
                        openFlyout('‚õèÔ∏è '+m.name, m.country||'', content);
                    });
            });

            // Mints
            mints.forEach(function(m) {
                var icon = createMarker(m.lat, m.lng, '#C0C0C0', 12);
                L.marker([m.lat, m.lng], {icon: icon}).addTo(mintsLayer)
                    .on('click', function() {
                        var content = '<div class="flyout-section"><h3>Details</h3>';
                        content += '<p><strong>Founded:</strong> '+(m.founded||m.year_founded||'Unknown')+'</p>';
                        if (m.notes || m.description) content += '<p>'+(m.notes||m.description)+'</p>';
                        content += '</div>';
                        openFlyout('ü™ô '+m.name, 'Colonial Mint', content);
                    });
            });

            // Pirate Havens
            pirates.forEach(function(p) {
                var icon = createMarker(p.lat, p.lng, '#000', 12, '2px solid #c0392b');
                L.marker([p.lat, p.lng], {icon: icon}).addTo(piratesLayer)
                    .on('click', function() {
                        var content = '<div class="flyout-section"><h3>Details</h3>';
                        if (p.period || p.active_period) content += '<p><strong>Active:</strong> '+(p.period||p.active_period)+'</p>';
                        if (p.notable_pirates) content += '<p><strong>Pirates:</strong> '+p.notable_pirates.join(', ')+'</p>';
                        if (p.notes || p.description) content += '<p>'+(p.notes||p.description)+'</p>';
                        content += '</div>';
                        openFlyout('üíÄ '+p.name, p.modern_location||p.country||'', content);
                    });
            });

            // Mystery Finds
            mystery.forEach(function(m) {
                var icon = createMarker(m.lat, m.lng, '#FFEB3B', 10, '2px solid #F57F17');
                L.marker([m.lat, m.lng], {icon: icon}).addTo(mysteryLayer)
                    .on('click', function() {
                        var content = '<div class="flyout-section"><h3>What Was Found</h3>';
                        content += '<p>'+(m.artifacts_found || m.description || 'Unknown artifacts')+'</p>';
                        if (m.year_discovered) content += '<p><strong>Discovered:</strong> '+m.year_discovered+'</p>';
                        if (m.theories) content += '<p><strong>Theories:</strong> '+m.theories+'</p>';
                        if (m.notes) content += '<p>'+m.notes+'</p>';
                        content += '</div>';
                        openFlyout('‚ùì '+m.name, 'Mystery Find', content);
                    });
            });

            // Salvage Leases
            salvageLeases.forEach(function(l) {
                L.polygon(l.coords, {color: l.color, weight: 2, fillOpacity: 0.15, dashArray: '6,4'})
                    .bindPopup('<b>üìú '+l.name+'</b><br>'+l.notes).addTo(leasesLayer);
            });

            // Voyage Incidents
            incidents.forEach(function(inc) {
                var color = '#e74c3c'; // battle red
                var emoji = '‚öîÔ∏è';
                if (inc.type && inc.type.includes('storm')) { color = '#9b59b6'; emoji = 'üåÄ'; }
                if (inc.type && inc.type.includes('sighting')) { color = '#3498db'; emoji = 'üëÅÔ∏è'; }
                if (inc.type && inc.type.includes('capture')) { color = '#e67e22'; emoji = 'üè¥‚Äç‚ò†Ô∏è'; }
                
                var icon = createMarker(inc.lat, inc.lng, color, 12, '2px solid #333');
                L.marker([inc.lat, inc.lng], {icon: icon}).addTo(incidentsLayer)
                    .on('click', function() {
                        var content = '<div class="info-box battle">';
                        content += '<strong>'+emoji+' '+(inc.type||'Incident').replace(/_/g,' ')+'</strong>';
                        content += '<p>'+inc.date+'</p></div>';
                        content += '<div class="flyout-section"><h3>Description</h3><p>'+inc.description+'</p></div>';
                        if (inc.ships_involved && inc.ships_involved.length) {
                            content += '<div class="flyout-section"><h3>Ships Involved</h3><p>'+inc.ships_involved.join(', ')+'</p></div>';
                        }
                        if (inc.pirates_involved && inc.pirates_involved.length && inc.pirates_involved[0] !== 'none') {
                            content += '<div class="flyout-section"><h3>Pirates</h3><p>'+inc.pirates_involved.join(', ')+'</p></div>';
                        }
                        if (inc.outcome) content += '<div class="flyout-section"><h3>Outcome</h3><p>'+inc.outcome+'</p></div>';
                        if (inc.loot) content += '<div class="flyout-section"><h3>Loot</h3><p>'+inc.loot+'</p></div>';
                        if (inc.casualties) content += '<div class="flyout-section"><h3>Casualties</h3><p>'+inc.casualties+'</p></div>';
                        if (inc.sources && inc.sources.length) {
                            content += '<div class="flyout-section"><h3>Sources</h3>';
                            inc.sources.forEach(function(s) {
                                if (typeof s === 'string') content += '<p>'+s+'</p>';
                                else if (s.book) content += '<p>'+s.book+' by '+s.author+'</p>';
                                else if (s.title) content += '<p>'+s.title+'</p>';
                            });
                            content += '</div>';
                        }
                        openFlyout(inc.name || 'Incident', inc.date||'', content);
                    });
            });

            // Pirate Raids (land attacks)
            var raids = (data.pirate_raids && data.pirate_raids.raids) || [];
            raids.forEach(function(raid) {
                if (!raid.lat || !raid.lng) return;
                var icon = createMarker(raid.lat, raid.lng, '#8B0000', 13, '2px solid #FFD700');
                L.marker([raid.lat, raid.lng], {icon: icon}).addTo(raidsLayer)
                    .on('click', function() {
                        var content = '<div class="info-box battle">';
                        content += '<strong>üè¥‚Äç‚ò†Ô∏è '+raid.type.replace(/_/g,' ')+'</strong>';
                        content += '<p>'+raid.date+'</p></div>';
                        content += '<div class="flyout-section"><h3>Pirate Leader</h3><p>'+raid.pirate_leader+'</p></div>';
                        if (raid.pirate_group) content += '<div class="flyout-section"><h3>Group</h3><p>'+raid.pirate_group+'</p></div>';
                        if (raid.force_size) content += '<div class="flyout-section"><h3>Force</h3><p>'+raid.force_size+'</p></div>';
                        content += '<div class="flyout-section"><h3>Target</h3><p>'+raid.target+'</p></div>';
                        if (raid.outcome) content += '<div class="flyout-section"><h3>Outcome</h3><p>'+raid.outcome+'</p></div>';
                        if (raid.loot) content += '<div class="flyout-section"><h3>Loot</h3><p>'+raid.loot+'</p></div>';
                        if (raid.description) content += '<div class="flyout-section"><h3>Description</h3><p>'+raid.description+'</p></div>';
                        if (raid.sources && raid.sources.length) {
                            content += '<div class="flyout-section"><h3>Sources</h3>';
                            raid.sources.forEach(function(s) {
                                if (s.book) content += '<p><em>'+s.book+'</em> by '+s.author+'</p>';
                            });
                            content += '</div>';
                        }
                        openFlyout('üè¥‚Äç‚ò†Ô∏è '+raid.name, raid.pirate_leader+' ‚Ä¢ '+raid.date, content);
                    });
            });

        // Gulf Oil Wells/Platforms
            var oilWells = (data.gulf_oil_wells && data.gulf_oil_wells.platforms) || [];
            oilWells.forEach(function(well) {
                if (!well.lat || !well.lng) return;
                var color = '#27ae60'; // active = green
                if (well.status === 'inactive') color = '#7f8c8d'; // grey
                if (well.status === 'abandoned' || well.status === 'decommissioned') color = '#2c3e50'; // black
                if (well.status === 'destroyed') color = '#c0392b'; // red
                
                var icon = createMarker(well.lat, well.lng, color, 8, '1px solid #333');
                L.marker([well.lat, well.lng], {icon: icon}).addTo(oilWellsLayer)
                    .on('click', function() {
                        var content = '<div class="flyout-section"><h3>Platform Info</h3>';
                        content += '<p><strong>Operator:</strong> '+(well.operator||'Unknown')+'</p>';
                        content += '<p><strong>Status:</strong> '+well.status+'</p>';
                        content += '<p><strong>Type:</strong> '+(well.type||'Unknown')+'</p>';
                        if (well.water_depth_ft) content += '<p><strong>Water Depth:</strong> '+well.water_depth_ft+' ft</p>';
                        if (well.install_date) content += '<p><strong>Installed:</strong> '+well.install_date+'</p>';
                        if (well.production) content += '<p><strong>Production:</strong> '+well.production+'</p>';
                        content += '</div>';
                        if (well.notes) content += '<div class="flyout-section"><h3>Notes</h3><p>'+well.notes+'</p></div>';
                        openFlyout('üõ¢Ô∏è '+(well.name||well.id), well.operator||'', content);
                    });
            });
        }

        // Load fishing spots from separate file
        fetch('fishing_spots.json?v=' + Date.now())
            .then(r => r.json())
            .then(fishData => {
                fishData.forEach(function(spot) {
                    if (!spot.lat || !spot.lon) return;
                    if (spot.type === 'fishing') {
                        var icon = L.divIcon({
                            className: 'fish',
                            html: '<div style="background:#00BFFF;width:8px;height:8px;border-radius:50%;border:1px solid #006699;opacity:0.8"></div>',
                            iconSize: [8, 8], iconAnchor: [4, 4]
                        });
                        L.marker([spot.lat, spot.lon], {icon: icon}).addTo(fishingLayer)
                            .bindPopup('<b>üé£ '+spot.name+'</b><br>Source: '+(spot.source||'OSM'));
                    } else if (spot.type === 'reef') {
                        var icon = L.divIcon({
                            className: 'reef',
                            html: '<div style="background:#7B68EE;width:8px;height:8px;border-radius:2px;border:1px solid #4B0082;opacity:0.8"></div>',
                            iconSize: [8, 8], iconAnchor: [4, 4]
                        });
                        var popup = '<b>ü™∏ '+spot.name+'</b>';
                        if (spot.depth) popup += '<br>Depth: '+spot.depth;
                        if (spot.notes) popup += '<br>'+spot.notes;
                        L.marker([spot.lat, spot.lon], {icon: icon}).addTo(reefsLayer).bindPopup(popup);
                    }
                });
            })
            .catch(e => console.log('Fishing spots not loaded:', e));

        // Toggle handlers
        document.getElementById('toggleWrecks').addEventListener('change', function() {
            this.checked ? map.addLayer(wrecksLayer) : map.removeLayer(wrecksLayer);
        });
        document.getElementById('toggleSeaRoutes').addEventListener('change', function() {
            this.checked ? map.addLayer(seaRoutesLayer) : map.removeLayer(seaRoutesLayer);
        });
        document.getElementById('toggleLandRoutes').addEventListener('change', function() {
            this.checked ? map.addLayer(landRoutesLayer) : map.removeLayer(landRoutesLayer);
        });
        document.getElementById('toggleMines').addEventListener('change', function() {
            this.checked ? map.addLayer(minesLayer) : map.removeLayer(minesLayer);
        });
        document.getElementById('toggleMints').addEventListener('change', function() {
            this.checked ? map.addLayer(mintsLayer) : map.removeLayer(mintsLayer);
        });
        document.getElementById('togglePirates').addEventListener('change', function() {
            this.checked ? map.addLayer(piratesLayer) : map.removeLayer(piratesLayer);
        });
        document.getElementById('toggleMystery').addEventListener('change', function() {
            this.checked ? map.addLayer(mysteryLayer) : map.removeLayer(mysteryLayer);
        });
        document.getElementById('toggleLeases').addEventListener('change', function() {
            this.checked ? map.addLayer(leasesLayer) : map.removeLayer(leasesLayer);
        });
        document.getElementById('toggleIncidents').addEventListener('change', function() {
            this.checked ? map.addLayer(incidentsLayer) : map.removeLayer(incidentsLayer);
        });
        document.getElementById('toggleRaids').addEventListener('change', function() {
            this.checked ? map.addLayer(raidsLayer) : map.removeLayer(raidsLayer);
        });
        document.getElementById('toggleOilWells').addEventListener('change', function() {
            this.checked ? map.addLayer(oilWellsLayer) : map.removeLayer(oilWellsLayer);
        });
        document.getElementById('toggleFishing').addEventListener('change', function() {
            this.checked ? map.addLayer(fishingLayer) : map.removeLayer(fishingLayer);
        });
        document.getElementById('toggleReefs').addEventListener('change', function() {
            this.checked ? map.addLayer(reefsLayer) : map.removeLayer(reefsLayer);
        });

        // Toggle all layers on/off
        function toggleAll(state) {
            var checkboxes = ['toggleWrecks','toggleSeaRoutes','toggleLandRoutes','toggleMines','toggleMints','togglePirates','toggleMystery','toggleLeases','toggleIncidents','toggleRaids','toggleOilWells','toggleFishing','toggleReefs'];
            checkboxes.forEach(function(id) {
                var cb = document.getElementById(id);
                if (cb) {
                    cb.checked = state;
                    cb.dispatchEvent(new Event('change'));
                }
            });
        }

        map.on('click', function(e) {
            L.popup().setLatLng(e.latlng)
                .setContent('<b>'+e.latlng.lat.toFixed(4)+'¬∞, '+e.latlng.lng.toFixed(4)+'¬∞</b>')
                .openOn(map);
        });

        L.control.scale({imperial: true, metric: true}).addTo(map);
        loadData();
    </script>
</body>
</html>
